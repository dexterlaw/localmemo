<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>LocalMemo 离线浮墨</title>
<!-- PWA核心配置 -->
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#2D6A4F">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="LocalMemo">
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
/* 全局配色完全对齐flomo绿系风格 */
:root {
  --flomo-primary: #2D6A4F;
  --flomo-primary-dark: #1B4332;
  --flomo-light-bg: #E8F3EE;
  --flomo-page-bg: #F8F9F6;
  --flomo-card-bg: #FFFFFF;
  --flomo-text-main: #1F2937;
  --flomo-text-secondary: #6B7280;
  --flomo-text-placeholder: #9CA3AF;
  --flomo-shadow: 0 2px 8px rgba(0,0,0,0.04);
  --flomo-danger: #DC2626;
  --flomo-success: #059669;
}
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
  background: var(--flomo-page-bg);
  color: var(--flomo-text-main);
  max-width: 680px;
  margin: 0 auto;
  padding: 20px;
  line-height: 1.6;
}
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  flex-wrap: wrap;
  gap: 12px;
}
.header h1 {
  font-size: 22px;
  font-weight: 500;
  color: var(--flomo-primary);
}
.btn-group {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}
.btn {
  padding: 6px 12px;
  border: 1px solid #E5E7EB;
  border-radius: 6px;
  background: var(--flomo-card-bg);
  color: var(--flomo-text-secondary);
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s ease;
}
.btn:hover {
  background: var(--flomo-light-bg);
  color: var(--flomo-primary);
  border-color: var(--flomo-light-bg);
}
.btn-primary {
  background: var(--flomo-primary);
  color: white;
  border-color: var(--flomo-primary);
}
.btn-primary:hover {
  background: var(--flomo-primary-dark);
  color: white;
}
.btn-danger {
  border-color: #FECACA;
  color: var(--flomo-danger);
}
.btn-danger:hover {
  background: #FEE2E2;
}
.input-card {
  background: var(--flomo-card-bg);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 24px;
  box-shadow: var(--flomo-shadow);
}
#content {
  width: 100%;
  min-height: 80px;
  border: none;
  outline: none;
  font-size: 15px;
  resize: vertical;
  background: transparent;
  color: var(--flomo-text-main);
  line-height: 1.6;
}
#content::placeholder {
  color: var(--flomo-text-placeholder);
}
.submit-wrap {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 10px;
}
.sync-status {
  font-size: 12px;
  color: var(--flomo-text-secondary);
}
.sync-status.success {
  color: var(--flomo-success);
}
.sync-status.error {
  color: var(--flomo-danger);
}
#submit {
  padding: 8px 20px;
  background: var(--flomo-primary);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: background 0.2s ease;
}
#submit:hover {
  background: var(--flomo-primary-dark);
}
.tags-cloud {
  margin-bottom: 20px;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}
.tag {
  padding: 4px 10px;
  background: var(--flomo-light-bg);
  color: var(--flomo-primary);
  border-radius: 16px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}
.tag.active {
  background: var(--flomo-primary);
  color: #fff;
}
.tag:hover:not(.active) {
  background: #D8EDE4;
}
.memo-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.memo-item {
  background: var(--flomo-card-bg);
  border-radius: 12px;
  padding: 16px;
  box-shadow: var(--flomo-shadow);
  transition: box-shadow 0.2s ease;
}
.memo-item:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.06);
}
.memo-time {
  font-size: 12px;
  color: var(--flomo-text-secondary);
  margin-bottom: 8px;
}
.memo-content {
  font-size: 15px;
  margin-bottom: 10px;
  word-break: break-word;
  color: var(--flomo-text-main);
}
/* 段落与引用块样式 */
.memo-content p {
  margin: 0 0 8px 0;
}
.memo-content p:last-child {
  margin-bottom: 0;
}
.memo-content blockquote {
  border-left: 3px solid var(--flomo-primary);
  background: var(--flomo-light-bg);
  padding: 8px 12px;
  margin: 8px 0;
  border-radius: 4px;
  color: var(--flomo-text-secondary);
}
.memo-content blockquote p {
  margin: 0 0 4px 0;
  font-size: 14px;
}
.memo-content blockquote p:last-child {
  margin-bottom: 0;
}
.memo-content .tag-span {
  color: var(--flomo-primary);
  font-weight: 500;
}
.memo-actions {
  display: flex;
  gap: 16px;
  font-size: 12px;
}
.memo-actions span {
  color: var(--flomo-text-secondary);
  cursor: pointer;
  transition: color 0.2s ease;
}
.memo-actions span:hover {
  color: var(--flomo-primary);
}
.empty {
  text-align: center;
  color: var(--flomo-text-placeholder);
  padding: 60px 0;
  font-size: 14px;
}
/* 同步设置弹窗 */
.modal-mask {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 999;
  padding: 20px;
}
.modal-mask.show {
  display: flex;
}
.modal-card {
  background: var(--flomo-card-bg);
  border-radius: 12px;
  width: 100%;
  max-width: 500px;
  padding: 24px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}
.modal-header h3 {
  font-size: 18px;
  font-weight: 500;
  color: var(--flomo-primary);
}
.modal-close {
  cursor: pointer;
  font-size: 20px;
  color: var(--flomo-text-secondary);
  line-height: 1;
}
.modal-close:hover {
  color: var(--flomo-text-main);
}
.form-item {
  margin-bottom: 16px;
}
.form-item label {
  display: block;
  font-size: 14px;
  color: var(--flomo-text-main);
  margin-bottom: 6px;
}
.form-item input {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #E5E7EB;
  border-radius: 6px;
  font-size: 14px;
  outline: none;
  transition: border-color 0.2s ease;
}
.form-item input:focus {
  border-color: var(--flomo-primary);
}
.form-tips {
  font-size: 12px;
  color: var(--flomo-text-secondary);
  margin-top: 4px;
  line-height: 1.4;
}
.modal-footer {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  margin-top: 24px;
}
/* 冲突弹窗 */
.conflict-actions {
  display: flex;
  gap: 10px;
  margin-top: 20px;
  flex-wrap: wrap;
}
.conflict-text {
  font-size: 14px;
  color: var(--flomo-text-main);
  margin-bottom: 10px;
}
</style>
</head>
<body>

<div class="header">
  <h1>LocalMemo 离线浮墨</h1>
  <div class="btn-group">
    <button class="btn" id="syncBtn">云同步设置</button>
    <button class="btn" id="export">导出备份</button>
    <button class="btn" id="import">导入备份</button>
    <button class="btn" id="cancelEdit" style="display: none;">取消编辑</button>
  </div>
</div>

<div class="input-card">
<textarea id="content" placeholder="写下此刻的想法，用 #标签 自动分类，点击笔记的「引用」按钮可续写…"></textarea>
<div class="submit-wrap">
  <div class="sync-status" id="syncStatus">未开启云同步</div>
  <button id="submit">保存笔记</button>
</div>
</div>

<div class="tags-cloud" id="tagsCloud"></div>
<div class="memo-list" id="memoList"></div>

<!-- 同步设置弹窗 -->
<div class="modal-mask" id="syncModal">
  <div class="modal-card">
    <div class="modal-header">
      <h3>云同步设置（GitHub Gist）</h3>
      <span class="modal-close" id="modalClose">×</span>
    </div>
    <div class="form-item">
      <label>GitHub Personal Access Token</label>
      <input type="password" id="githubToken" placeholder="请输入仅开启gist权限的Token">
      <p class="form-tips">Token仅存在本地浏览器，不会上传到任何服务器，最小权限仅勾选gist即可</p>
    </div>
    <div class="form-item">
      <label>Gist ID</label>
      <input type="text" id="gistId" placeholder="请输入用于同步的Gist ID">
      <p class="form-tips">需创建Secret私密Gist，文件名建议为localmemo_sync.json</p>
    </div>
    <div class="modal-footer">
      <button class="btn" id="clearSyncConfig">清空配置</button>
      <button class="btn btn-primary" id="saveSyncConfig">保存并开启同步</button>
    </div>
  </div>
</div>

<!-- 冲突处理弹窗 -->
<div class="modal-mask" id="conflictModal">
  <div class="modal-card">
    <div class="modal-header">
      <h3>数据冲突提醒</h3>
    </div>
    <p class="conflict-text">检测到云端和本地数据均有更新，存在冲突，请选择要保留的版本：</p>
    <div class="conflict-actions">
      <button class="btn" id="keepLocal">保留本地版本（覆盖云端）</button>
      <button class="btn btn-primary" id="keepCloud">保留云端版本（覆盖本地）</button>
    </div>
  </div>
</div>

<script>
// 核心存储Key
const STORAGE_KEY = 'localmemo_flomo_data';
const SYNC_CONFIG_KEY = 'localmemo_sync_config';
const LAST_SYNC_TIME_KEY = 'localmemo_last_sync_time';

// 全局状态
let currentTag = '';
let editId = null;
let syncLock = false; // 同步锁，避免重复请求
let syncConfig = {
  token: '',
  gistId: ''
};

// ========== 新增：内容格式化核心函数（处理引用块、标签、XSS转义） ==========
function formatContent(content) {
  // 第一步：HTML转义，防止XSS攻击
  let escaped = content
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
  
  // 第二步：按行处理，转换引用块与段落
  const lines = escaped.split('\n');
  let html = '';
  let inBlockquote = false;
  
  lines.forEach(line => {
    const isQuoteLine = line.trimStart().startsWith('&gt;'); // 匹配转义后的>开头的引用行

    if (isQuoteLine) {
      if (!inBlockquote) {
        html += '<blockquote>';
        inBlockquote = true;
      }
      // 移除引用标记，保留内容
      const lineContent = line.replace(/^&gt;\s?/, '');
      html += `<p>${lineContent}</p>`;
    } else {
      if (inBlockquote) {
        html += '</blockquote>';
        inBlockquote = false;
      }
      // 普通行：非空内容加段落标签，空行加换行
      html += line.trim() !== '' ? `<p>${line}</p>` : '<br>';
    }
  });

  // 处理末尾未闭合的引用块
  if (inBlockquote) html += '</blockquote>';

  // 第三步：标签高亮处理
  html = html.replace(/#([^\s#<>&]+)/g, '<span class="tag-span">#$1</span>');

  return html;
}

// ========== 新增：引用功能核心函数 ==========
function quoteMemo(id) {
  const list = loadData();
  const targetMemo = list.find(item => item.id === id);
  if (!targetMemo) return;

  // 重置编辑状态，避免冲突
  editId = null;
  document.getElementById('submit').textContent = '保存笔记';
  document.getElementById('cancelEdit').style.display = 'none';

  // 生成带溯源信息的引用内容，标准markdown格式
  const quoteHeader = `> 【引用自 ${targetMemo.createdAt}】\n`;
  const quoteContent = targetMemo.content.split('\n').map(line => `> ${line}`).join('\n');
  const fullContent = quoteHeader + quoteContent + '\n\n';

  // 回填到输入框，自动聚焦并滚动到顶部
  const contentInput = document.getElementById('content');
  contentInput.value = fullContent;
  contentInput.focus();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ========== 原有核心功能（完全保留兼容） ==========
// 加载本地数据
function loadData() {
  const raw = localStorage.getItem(STORAGE_KEY);
  return raw ? JSON.parse(raw) : [];
}

// 保存数据到本地
function saveData(list) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
}

// 提交/更新笔记
function submitMemo() {
  const content = document.getElementById('content').value.trim();
  if (!content) return;
  
  const list = loadData();
  const now = new Date();
  const timeStr = now.toLocaleString('zh-CN');
  const tagMatch = content.match(/#([^\s#]+)/g) || [];
  const tags = tagMatch.map(t => t.slice(1));

  // 编辑模式：更新原有笔记
  if (editId) {
    const index = list.findIndex(item => item.id === editId);
    if (index !== -1) {
      list[index].content = content;
      list[index].tags = tags;
      list[index].updatedAt = timeStr;
    }
    // 重置编辑状态
    editId = null;
    document.getElementById('submit').textContent = '保存笔记';
    document.getElementById('cancelEdit').style.display = 'none';
  } else {
    // 新增模式：创建新笔记
    const item = {
      id: Date.now(),
      content,
      tags,
      createdAt: timeStr,
      updatedAt: timeStr
    };
    list.unshift(item);
  }

  saveData(list);
  document.getElementById('content').value = '';
  document.getElementById('content').focus();
  render();
  // 保存后自动同步到云端
  autoSyncToCloud();
}

// 编辑笔记：回填内容到输入框
function editMemo(id) {
  const list = loadData();
  const item = list.find(x => x.id === id);
  if (!item) return;
  
  editId = id;
  document.getElementById('content').value = item.content;
  document.getElementById('content').focus();
  document.getElementById('submit').textContent = '更新笔记';
  document.getElementById('cancelEdit').style.display = 'inline-block';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// 删除笔记
function deleteMemo(id) {
  if (!confirm('确定要删除这条笔记吗？')) return;
  let list = loadData();
  list = list.filter(x => x.id !== id);
  saveData(list);
  // 如果删除的是正在编辑的笔记，重置编辑状态
  if (editId === id) {
    editId = null;
    document.getElementById('content').value = '';
    document.getElementById('submit').textContent = '保存笔记';
    document.getElementById('cancelEdit').style.display = 'none';
  }
  render();
  // 删除后自动同步到云端
  autoSyncToCloud();
}

// 取消编辑
function cancelEdit() {
  editId = null;
  document.getElementById('content').value = '';
  document.getElementById('submit').textContent = '保存笔记';
  document.getElementById('cancelEdit').style.display = 'none';
}

// 渲染标签云
function renderTags() {
  const list = loadData();
  const tagCount = {};
  list.forEach(item => {
    item.tags.forEach(t => {
      tagCount[t] = (tagCount[t] || 0) + 1;
    });
  });

  const cloud = document.getElementById('tagsCloud');
  cloud.innerHTML = '';

  // 全部标签按钮
  const allTag = document.createElement('span');
  allTag.className = 'tag' + (currentTag === '' ? ' active' : '');
  allTag.textContent = '全部笔记';
  allTag.onclick = () => { currentTag = ''; render(); };
  cloud.appendChild(allTag);

  // 生成所有标签
  Object.keys(tagCount).sort().forEach(tag => {
    const tagEl = document.createElement('span');
    tagEl.className = 'tag' + (currentTag === tag ? ' active' : '');
    tagEl.textContent = `${tag} (${tagCount[tag]})`;
    tagEl.onclick = () => { currentTag = tag; render(); };
    cloud.appendChild(tagEl);
  });
}

// 渲染笔记列表
function renderList() {
  const list = loadData();
  const container = document.getElementById('memoList');
  container.innerHTML = '';

  // 按标签筛选
  let filteredList = list;
  if (currentTag) {
    filteredList = list.filter(item => item.tags.includes(currentTag));
  }

  // 空状态
  if (filteredList.length === 0) {
    container.innerHTML = '<div class="empty">暂无笔记，写下你的第一条想法吧</div>';
    return;
  }

  // 渲染单条笔记
  filteredList.forEach(item => {
    const memoEl = document.createElement('div');
    memoEl.className = 'memo-item';
    
    // 时间显示（优先显示更新时间）
    const timeText = item.updatedAt !== item.createdAt 
      ? `${item.createdAt}（更新于 ${item.updatedAt}）` 
      : item.createdAt;
    
    // 内容格式化：处理引用块、标签高亮
    const formatHtml = formatContent(item.content);

    // 新增引用按钮，放在编辑与删除之间
    memoEl.innerHTML = `
      <div class="memo-time">${timeText}</div>
      <div class="memo-content">${formatHtml}</div>
      <div class="memo-actions">
        <span onclick="editMemo(${item.id})">编辑</span>
        <span onclick="quoteMemo(${item.id})">引用</span>
        <span onclick="deleteMemo(${item.id})">删除</span>
      </div>
    `;
    container.appendChild(memoEl);
  });
}

// 统一渲染入口
function render() {
  renderTags();
  renderList();
}

// 导出备份
function exportData() {
  const data = localStorage.getItem(STORAGE_KEY) || '[]';
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `LocalMemo备份_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

// 导入备份
function importData() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      try {
        const data = JSON.parse(ev.target.result);
        if (Array.isArray(data)) {
          saveData(data);
          render();
          alert('备份导入成功！');
          // 导入后自动同步到云端
          autoSyncToCloud();
        } else {
          alert('备份格式错误，请选择正确的LocalMemo备份文件');
        }
      } catch (err) {
        alert('文件解析失败，请检查文件是否损坏');
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

// 快捷键：Ctrl+Enter / Cmd+Enter 快速提交
document.getElementById('content').addEventListener('keydown', (e) => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
    e.preventDefault();
    submitMemo();
  }
});

// ========== 云同步核心功能（完全保留兼容） ==========
// 加载同步配置
function loadSyncConfig() {
  const raw = localStorage.getItem(SYNC_CONFIG_KEY);
  if (raw) {
    try {
      syncConfig = JSON.parse(raw);
      updateSyncStatus('已开启云同步', 'success');
      return true;
    } catch (e) {
      syncConfig = { token: '', gistId: '' };
    }
  }
  updateSyncStatus('未开启云同步', '');
  return false;
}

// 保存同步配置
function saveSyncConfig() {
  const token = document.getElementById('githubToken').value.trim();
  const gistId = document.getElementById('gistId').value.trim();
  
  if (!token || !gistId) {
    alert('请填写完整的Token和Gist ID');
    return;
  }

  syncConfig = { token, gistId };
  localStorage.setItem(SYNC_CONFIG_KEY, JSON.stringify(syncConfig));
  closeSyncModal();
  updateSyncStatus('同步配置已保存，正在连接...', 'success');
  
  // 保存后立即拉取云端数据
  syncFromCloud();
}

// 清空同步配置
function clearSyncConfig() {
  if (!confirm('确定要清空同步配置吗？清空后将关闭云同步功能')) return;
  syncConfig = { token: '', gistId: '' };
  localStorage.removeItem(SYNC_CONFIG_KEY);
  localStorage.removeItem(LAST_SYNC_TIME_KEY);
  document.getElementById('githubToken').value = '';
  document.getElementById('gistId').value = '';
  closeSyncModal();
  updateSyncStatus('未开启云同步', '');
}

// 更新同步状态显示
function updateSyncStatus(text, type = '') {
  const statusEl = document.getElementById('syncStatus');
  statusEl.textContent = text;
  statusEl.className = 'sync-status ' + type;
}

// 从云端拉取数据
async function fetchCloudData() {
  if (!syncConfig.token || !syncConfig.gistId) return null;
  
  try {
    const response = await fetch(`https://api.github.com/gists/${syncConfig.gistId}`, {
      method: 'GET',
      headers: {
        'Authorization': `token ${syncConfig.token}`,
        'Accept': 'application/vnd.github.v3+json',
        'User-Agent': 'LocalMemo'
      }
    });

    if (!response.ok) {
      throw new Error(`请求失败: ${response.status}`);
    }

    const gistData = await response.json();
    // 获取第一个文件的内容
    const fileName = Object.keys(gistData.files)[0];
    const fileContent = gistData.files[fileName].content;
    const syncData = JSON.parse(fileContent);
    
    return {
      data: Array.isArray(syncData.data) ? syncData.data : [],
      updatedAt: gistData.updated_at,
      fileName
    };
  } catch (e) {
    console.error('拉取云端数据失败', e);
    updateSyncStatus(`同步失败: ${e.message}`, 'error');
    return null;
  }
}

// 上传数据到云端
async function uploadToCloud(data) {
  if (!syncConfig.token || !syncConfig.gistId || syncLock) return false;
  
  syncLock = true;
  updateSyncStatus('正在同步到云端...', 'success');
  
  try {
    const cloudInfo = await fetchCloudData();
    if (!cloudInfo) {
      syncLock = false;
      return false;
    }

    const syncData = {
      data: data,
      lastSync: new Date().toISOString()
    };

    const response = await fetch(`https://api.github.com/gists/${syncConfig.gistId}`, {
      method: 'PATCH',
      headers: {
        'Authorization': `token ${syncConfig.token}`,
        'Accept': 'application/vnd.github.v3+json',
        'User-Agent': 'LocalMemo'
      },
      body: JSON.stringify({
        files: {
          [cloudInfo.fileName]: {
            content: JSON.stringify(syncData, null, 2)
          }
        }
      })
    });

    if (!response.ok) {
      throw new Error(`上传失败: ${response.status}`);
    }

    const now = new Date().toISOString();
    localStorage.setItem(LAST_SYNC_TIME_KEY, now);
    updateSyncStatus(`最后同步: ${new Date().toLocaleString('zh-CN')}`, 'success');
    syncLock = false;
    return true;
  } catch (e) {
    console.error('上传云端数据失败', e);
    updateSyncStatus(`同步失败: ${e.message}`, 'error');
    syncLock = false;
    return false;
  }
}

// 冲突检测与处理
async function checkConflict(cloudUpdatedAt) {
  const lastSyncTime = localStorage.getItem(LAST_SYNC_TIME_KEY);
  // 第一次同步，无冲突
  if (!lastSyncTime) return false;
  
  // 云端更新时间晚于最后一次同步时间，说明云端有更新
  const cloudIsNewer = new Date(cloudUpdatedAt) > new Date(lastSyncTime);
  // 本地数据更新时间晚于最后一次同步时间，说明本地有更新
  const localData = loadData();
  const localLastUpdate = localData.length > 0 
    ? new Date(localData[0].updatedAt).toISOString() 
    : new Date(0).toISOString();
  const localIsNewer = new Date(localLastUpdate) > new Date(lastSyncTime);

  // 两边都有更新，存在冲突
  return cloudIsNewer && localIsNewer;
}

// 从云端同步到本地
async function syncFromCloud() {
  if (!loadSyncConfig() || syncLock) return;
  
  syncLock = true;
  updateSyncStatus('正在拉取云端数据...', 'success');
  
  const cloudResult = await fetchCloudData();
  if (!cloudResult) {
    syncLock = false;
    return;
  }

  // 检测冲突
  const hasConflict = await checkConflict(cloudResult.updatedAt);
  if (hasConflict) {
    syncLock = false;
    showConflictModal(cloudResult.data);
    return;
  }

  // 无冲突，直接用云端数据覆盖本地
  saveData(cloudResult.data);
  const now = new Date().toISOString();
  localStorage.setItem(LAST_SYNC_TIME_KEY, now);
  updateSyncStatus(`最后同步: ${new Date().toLocaleString('zh-CN')}`, 'success');
  render();
  syncLock = false;
}

// 自动同步到云端（操作后触发）
async function autoSyncToCloud() {
  if (!loadSyncConfig()) return;
  const localData = loadData();
  await uploadToCloud(localData);
}

// 冲突弹窗相关
function showConflictModal(cloudData) {
  const modal = document.getElementById('conflictModal');
  modal.classList.add('show');

  // 保留本地
  document.getElementById('keepLocal').onclick = async () => {
    const localData = loadData();
    await uploadToCloud(localData);
    modal.classList.remove('show');
  };

  // 保留云端
  document.getElementById('keepCloud').onclick = () => {
    saveData(cloudData);
    const now = new Date().toISOString();
    localStorage.setItem(LAST_SYNC_TIME_KEY, now);
    render();
    updateSyncStatus(`最后同步: ${new Date().toLocaleString('zh-CN')}`, 'success');
    modal.classList.remove('show');
    syncLock = false;
  };
}

// 同步设置弹窗相关
function openSyncModal() {
  loadSyncConfig();
  document.getElementById('githubToken').value = syncConfig.token;
  document.getElementById('gistId').value = syncConfig.gistId;
  document.getElementById('syncModal').classList.add('show');
}

function closeSyncModal() {
  document.getElementById('syncModal').classList.remove('show');
}

// ========== PWA核心注册（完全保留兼容） ==========
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(registration => {
        console.log('LocalMemo PWA 注册成功', registration);
      })
      .catch(err => {
        console.log('LocalMemo PWA 注册失败', err);
      });
  });
}

// ========== 事件绑定与初始化 ==========
// 原有功能事件绑定
document.getElementById('submit').onclick = submitMemo;
document.getElementById('export').onclick = exportData;
document.getElementById('import').onclick = importData;
document.getElementById('cancelEdit').onclick = cancelEdit;

// 同步功能事件绑定
document.getElementById('syncBtn').onclick = openSyncModal;
document.getElementById('modalClose').onclick = closeSyncModal;
document.getElementById('saveSyncConfig').onclick = saveSyncConfig;
document.getElementById('clearSyncConfig').onclick = clearSyncConfig;

// 点击弹窗遮罩关闭
document.getElementById('syncModal').onclick = (e) => {
  if (e.target === document.getElementById('syncModal')) closeSyncModal();
};

// 页面获得焦点时，自动检查云端更新
window.addEventListener('focus', () => {
  if (loadSyncConfig()) {
    syncFromCloud();
  }
});

// 页面加载初始化
window.onload = () => {
  loadSyncConfig();
  render();
  // 开启同步的话，页面加载自动拉取云端数据
  if (syncConfig.token && syncConfig.gistId) {
    syncFromCloud();
    // 每5分钟自动同步一次
    setInterval(() => {
      syncFromCloud();
    }, 5 * 60 * 1000);
  }
};
</script>
</body>
</html>
