<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>LocalMemo ç¦»çº¿æµ®å¢¨</title>
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#2D6A4F">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="LocalMemo">
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
:root {
  --flomo-primary: #2D6A4F;
  --flomo-primary-dark: #1B4333;
  --flomo-light-bg: #E8F3EE;
  --flomo-page-bg: #F8F9F6;
  --flomo-card-bg: #FFFFFF;
  --flomo-text-main: #1F2937;
  --flomo-text-secondary: #6B7280;
  --flomo-text-placeholder: #9CA3AF;
  --flomo-shadow: 0 2px 8px rgba(0,0,0,0.04);
  --flomo-danger: #DC2626;
  --flomo-success: #059669;
}
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
  background: var(--flomo-page-bg);
  color: var(--flomo-text-main);
  max-width: 680px;
  margin: 0 auto;
  padding: 20px;
  line-height: 1.6;
}

.fade-in {
  animation: fadeIn 0.25s ease forwards;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(6px); }
  to { opacity: 1; transform: translateY(0); }
}

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  flex-wrap: wrap;
  gap: 10px;
}
.header h1 {
  font-size: 22px;
  font-weight: 500;
  color: var(--flomo-primary);
}
.btn-group {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}
.btn {
  padding: 6px 10px;
  border: 1px solid #E5E7EB;
  border-radius: 6px;
  background: var(--flomo-card-bg);
  color: var(--flomo-text-secondary);
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s ease;
}
.btn:hover {
  background: var(--flomo-light-bg);
  color: var(--flomo-primary);
  border-color: var(--flomo-light-bg);
}
.btn-primary {
  background: var(--flomo-primary);
  color: white;
  border-color: var(--flomo-primary);
}
.btn-primary:hover {
  background: var(--flomo-primary-dark);
}

.tab-bar {
  display: flex;
  background: #fff;
  border-radius: 10px;
  padding: 4px;
  margin-bottom: 16px;
  box-shadow: var(--flomo-shadow);
}
.tab-item {
  flex: 1;
  text-align: center;
  padding: 8px 0;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 500;
  color: var(--flomo-text-secondary);
  transition: all 0.2s ease;
}
.tab-item.active {
  background: var(--flomo-primary);
  color: #fff;
}
.tab-item:hover:not(.active) {
  background: var(--flomo-light-bg);
  color: var(--flomo-primary);
}

.page {
  display: none;
}
.page.active {
  display: block;
}

.input-card {
  background: var(--flomo-card-bg);
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: var(--flomo-shadow);
}
#content {
  width: 100%;
  min-height: 80px;
  border: none;
  outline: none;
  font-size: 15px;
  resize: vertical;
  background: transparent;
  color: var(--flomo-text-main);
  line-height: 1.6;
}
#content::placeholder {
  color: var(--flomo-text-placeholder);
}
.submit-wrap {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 10px;
}
.sync-status {
  font-size: 12px;
  color: var(--flomo-text-secondary);
}
.sync-status.success {
  color: var(--flomo-success);
}
.sync-status.error {
  color: var(--flomo-danger);
}
#submit {
  padding: 8px 20px;
  background: var(--flomo-primary);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: background 0.2s ease;
}
#submit:hover {
  background: var(--flomo-primary-dark);
}

.tags-cloud {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 16px;
}
.tag {
  padding: 4px 10px;
  background: var(--flomo-light-bg);
  color: var(--flomo-primary);
  border-radius: 16px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
}
.tag.active {
  background: var(--flomo-primary);
  color: #fff;
}

.memo-list, .todo-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.memo-item, .todo-item {
  background: var(--flomo-card-bg);
  border-radius: 12px;
  padding: 14px;
  box-shadow: var(--flomo-shadow);
  transition: all 0.22s ease;
}
.memo-item:hover, .todo-item:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  transform: translateY(-1px);
}
.memo-time {
  font-size: 12px;
  color: var(--flomo-text-secondary);
  margin-bottom: 6px;
}
.memo-content {
  font-size: 15px;
  margin-bottom: 10px;
  word-break: break-word;
}
.memo-content p {
  margin: 0 0 6px 0;
}
.memo-content blockquote {
  border-left: 3px solid var(--flomo-primary);
  background: var(--flomo-light-bg);
  padding: 6px 10px;
  margin: 6px 0;
  border-radius: 4px;
  color: var(--flomo-text-secondary);
}
.memo-content .tag-span {
  color: var(--flomo-primary);
  font-weight: 500;
}

.todo-hd {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
}
.todo-checkbox {
  width: 18px;
  height: 18px;
  accent-color: var(--flomo-primary);
  cursor: pointer;
}
.todo-tag {
  font-size: 12px;
  padding: 2px 6px;
  border-radius: 4px;
  background: #FEF3C7;
  color: #92400E;
}
.todo-item.done .todo-tag {
  background: #D1FAE5;
  color: #065F46;
}
.todo-title {
  font-weight: 500;
  margin-bottom: 6px;
}
.todo-item.done .todo-title {
  text-decoration: line-through;
  color: var(--flomo-text-secondary);
}

/* å¤„ç†è®°å½•æ ·å¼ */
.handle-record {
  background: #F9FAFB;
  border-left: 2px solid var(--flomo-primary);
  padding: 6px 10px;
  font-size: 13px;
  color: #374151;
  border-radius: 4px;
  margin-top: 4px;
}
.handle-time {
  color: var(--flomo-text-secondary);
  font-size: 12px;
  margin-right: 4px;
}

.memo-actions, .todo-actions {
  display: flex;
  gap: 14px;
  font-size: 12px;
  margin-top: 8px;
}
.memo-actions span, .todo-actions span {
  color: var(--flomo-text-secondary);
  cursor: pointer;
  transition: color 0.2s;
}
.memo-actions span:hover, .todo-actions span:hover {
  color: var(--flomo-primary);
}
span.del {
  color: var(--flomo-danger) !important;
}

.empty {
  text-align: center;
  color: var(--flomo-text-placeholder);
  padding: 50px 0;
  font-size: 14px;
}

.modal-mask {
  position: fixed;
  top:0;left:0;right:0;bottom:0;
  background: rgba(0,0,0,0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 999;
  padding: 20px;
}
.modal-mask.show {
  display: flex;
}
.modal-card {
  background: #fff;
  border-radius: 12px;
  width: 100%;
  max-width: 500px;
  padding: 20px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}
.modal-header h3 {
  font-size: 18px;
  font-weight: 500;
  color: var(--flomo-primary);
}
.modal-close {
  font-size: 20px;
  cursor: pointer;
  color: var(--flomo-text-secondary);
}
.form-item {
  margin-bottom: 14px;
}
.form-item label {
  display: block;
  font-size: 14px;
  margin-bottom: 6px;
}
.form-item input,
.form-item textarea {
  width: 100%;
  padding: 8px 10px;
  border: 1px solid #E5E7EB;
  border-radius: 6px;
  font-size: 14px;
  outline: none;
}
.form-item textarea {
  min-height: 100px;
  resize: vertical;
}
.modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 20px;
}
</style>
</head>
<body>

<div class="header">
  <h1>LocalMemo</h1>
  <div class="btn-group">
    <button class="btn" id="syncBtn">äº‘åŒæ­¥</button>
    <button class="btn" id="export">å¯¼å‡º</button>
    <button class="btn" id="import">å¯¼å…¥</button>
    <button class="btn" id="cancelEdit" style="display:none;">å–æ¶ˆ</button>
  </div>
</div>

<div class="tab-bar">
  <div class="tab-item active" data-page="memo">ğŸ“ ç¬”è®°</div>
  <div class="tab-item" data-page="todo">â˜‘ å¾…åŠ</div>
</div>

<div id="memoPage" class="page active fade-in">
  <div class="input-card">
    <textarea id="content" placeholder="è®°å½•æƒ³æ³•ã€çµæ„Ÿã€æ€»ç»“ï¼Œ#æ ‡ç­¾ è‡ªåŠ¨åˆ†ç±»"></textarea>
    <div class="submit-wrap">
      <div class="sync-status" id="syncStatus">æœªå¼€å¯äº‘åŒæ­¥</div>
      <button id="submit">ä¿å­˜ç¬”è®°</button>
    </div>
  </div>
  <div class="tags-cloud" id="tagsCloud"></div>
  <div class="memo-list" id="memoList"></div>
</div>

<div id="todoPage" class="page fade-in">
  <div class="input-card">
    <div style="margin-bottom:10px;font-weight:500;">æ–°å¢å¾…åŠ</div>
    <input type="text" id="todoTitle" placeholder="è¾“å…¥å¾…åŠäº‹é¡¹â€¦" style="margin-bottom:8px;width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:6px;outline:0;">
    <div style="text-align:right;margin-top:10px;">
      <button id="addTodo" class="btn btn-primary">ä¿å­˜å¾…åŠ</button>
    </div>
  </div>
  <div class="todo-list" id="todoList"></div>
</div>

<!-- å¤„ç†å¾…åŠå¼¹çª— -->
<div class="modal-mask" id="handleTodoModal">
  <div class="modal-card">
    <div class="modal-header">
      <h3>å¤„ç†è¿›åº¦</h3>
      <span class="modal-close" id="closeHandleModal">Ã—</span>
    </div>
    <div class="form-item">
      <label>æœ¬æ¬¡å¤„ç†å†…å®¹</label>
      <textarea id="handleContent" placeholder="è¾“å…¥æœ¬æ¬¡å¤„ç†è¿›å±•â€¦"></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn" id="cancelHandle">å–æ¶ˆ</button>
      <button class="btn btn-primary" id="saveHandle">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- åŒæ­¥å¼¹çª— -->
<div class="modal-mask" id="syncModal">
  <div class="modal-card">
    <div class="modal-header">
      <h3>äº‘åŒæ­¥è®¾ç½®</h3>
      <span class="modal-close" id="modalClose">Ã—</span>
    </div>
    <div class="form-item">
      <label>GitHub Token</label>
      <input type="password" id="githubToken" placeholder="ghp_...">
    </div>
    <div class="form-item">
      <label>Gist ID</label>
      <input type="text" id="gistId">
    </div>
    <div class="modal-footer">
      <button class="btn" id="clearSyncConfig">æ¸…ç©º</button>
      <button class="btn btn-primary" id="saveSyncConfig">ä¿å­˜</button>
    </div>
  </div>
</div>

<script>
const STORAGE_KEY = 'localmemo_flomo_data';
const SYNC_CONFIG_KEY = 'localmemo_sync_config';
const LAST_SYNC_TIME_KEY = 'localmemo_last_sync_time';

let currentTag = '';
let editId = null;
let syncLock = false;
let currentHandleTodoId = null;
let syncConfig = { token: '', gistId: '' };

// Tab åˆ‡æ¢
document.querySelectorAll('.tab-item').forEach(el => {
  el.onclick = () => {
    document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
    el.classList.add('active');
    const page = el.dataset.page;
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(page + 'Page').classList.add('active');
  };
});

// æ•°æ®
function loadData() {
  const raw = localStorage.getItem(STORAGE_KEY);
  return raw ? JSON.parse(raw) : [];
}
function saveData(list) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
}

// æ¸²æŸ“ç¬”è®°å†…å®¹
function formatContent(content) {
  let esc = content.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  const lines = esc.split('\n');
  let html = '';
  let inQuote = false;
  lines.forEach(line => {
    const isQ = line.trimStart().startsWith('&gt;');
    if (isQ) {
      if (!inQuote) { html += '<blockquote>'; inQuote = true; }
      html += `<p>${line.replace(/^&gt;\s?/, '')}</p>`;
    } else {
      if (inQuote) { html += '</blockquote>'; inQuote = false; }
      html += line.trim() ? `<p>${line}</p>` : '<br>';
    }
  });
  if (inQuote) html += '</blockquote>';
  return html.replace(/#([^\s#<>&]+)/g, '<span class="tag-span">#$1</span>');
}

// ç¬”è®°æ“ä½œ
function submitMemo() {
  const c = document.getElementById('content').value.trim();
  if (!c) return;
  const list = loadData();
  const now = new Date().toLocaleString('zh-CN');
  const tags = (c.match(/#([^\s#]+)/g) || []).map(t => t.slice(1));
  if (editId) {
    const i = list.findIndex(x => x.id === editId);
    if (i !== -1) {
      list[i].content = c;
      list[i].tags = tags;
      list[i].updatedAt = now;
    }
    editId = null;
    document.getElementById('submit').textContent = 'ä¿å­˜ç¬”è®°';
    document.getElementById('cancelEdit').style.display = 'none';
  } else {
    list.unshift({ id: Date.now(), content: c, tags, createdAt: now, updatedAt: now, type: 'memo' });
  }
  saveData(list);
  document.getElementById('content').value = '';
  renderAll();
  autoSyncToCloud();
}

function editMemo(id) {
  const list = loadData();
  const item = list.find(x => x.id === id);
  if (!item) return;
  editId = id;
  document.getElementById('content').value = item.content;
  document.getElementById('content').focus();
  document.getElementById('submit').textContent = 'æ›´æ–°ç¬”è®°';
  document.getElementById('cancelEdit').style.display = 'inline-block';
  document.querySelector('.tab-item[data-page="memo"]').click();
}

function quoteMemo(id) {
  const list = loadData();
  const m = list.find(x => x.id === id);
  if (!m) return;
  editId = null;
  document.getElementById('submit').textContent = 'ä¿å­˜ç¬”è®°';
  document.getElementById('cancelEdit').style.display = 'none';
  const q = `> å¼•ç”¨ ${m.createdAt}\n` + m.content.split('\n').map(l => `> ${l}`).join('\n') + '\n\n';
  document.getElementById('content').value = q;
  document.getElementById('content').focus();
  document.querySelector('.tab-item[data-page="memo"]').click();
}

function deleteMemo(id) {
  if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
  let list = loadData().filter(x => x.id !== id);
  saveData(list);
  if (editId === id) { editId = null; document.getElementById('content').value = ''; }
  renderAll();
  autoSyncToCloud();
}

function cancelEdit() {
  editId = null;
  document.getElementById('content').value = '';
  document.getElementById('submit').textContent = 'ä¿å­˜ç¬”è®°';
  document.getElementById('cancelEdit').style.display = 'none';
}

// å¾…åŠæ“ä½œ
function addTodo() {
  const title = document.getElementById('todoTitle').value.trim();
  if (!title) { alert('è¯·è¾“å…¥å¾…åŠ'); return; }
  const list = loadData();
  list.unshift({
    id: Date.now(),
    type: 'todo',
    title,
    records: [],
    done: false,
    createdAt: new Date().toLocaleString('zh-CN')
  });
  saveData(list);
  document.getElementById('todoTitle').value = '';
  renderAll();
  autoSyncToCloud();
}

function toggleTodo(id) {
  const list = loadData();
  const t = list.find(x => x.id === id);
  if (t) { t.done = !t.done; saveData(list); renderAll(); autoSyncToCloud(); }
}

// æ‰“å¼€å¤„ç†å¼¹çª—
function openHandleTodo(id) {
  currentHandleTodoId = id;
  document.getElementById('handleContent').value = '';
  document.getElementById('handleTodoModal').classList.add('show');
}

// å…³é—­å¤„ç†å¼¹çª—
function closeHandleTodo() {
  document.getElementById('handleTodoModal').classList.remove('show');
  currentHandleTodoId = null;
}

// ä¿å­˜å¤„ç†è®°å½•ï¼ˆè¿½åŠ æ¨¡å¼ï¼‰
function saveHandleTodo() {
  if (!currentHandleTodoId) return;
  const content = document.getElementById('handleContent').value.trim();
  if (!content) { alert('è¯·è¾“å…¥å¤„ç†å†…å®¹'); return; }

  const list = loadData();
  const item = list.find(x => x.id === currentHandleTodoId);
  if (item) {
    const now = new Date().toLocaleString('zh-CN');
    if (!item.records) item.records = [];
    item.records.push({
      time: now,
      content: content
    });
    saveData(list);
    renderAll();
    autoSyncToCloud();
  }
  closeHandleTodo();
}

function deleteTodo(id) {
  if (!confirm('åˆ é™¤è¯¥å¾…åŠï¼Ÿ')) return;
  const list = loadData().filter(x => x.id !== id);
  saveData(list);
  renderAll();
  autoSyncToCloud();
}

// æ¸²æŸ“
function renderTags() {
  const list = loadData().filter(x => x.type === 'memo');
  const map = {};
  list.forEach(i => i.tags?.forEach(t => map[t] = (map[t] || 0) + 1));
  const cloud = document.getElementById('tagsCloud');
  cloud.innerHTML = '';
  const all = document.createElement('span');
  all.className = 'tag' + (currentTag === '' ? ' active' : '');
  all.textContent = 'å…¨éƒ¨';
  all.onclick = () => { currentTag = ''; renderAll(); };
  cloud.appendChild(all);
  Object.keys(map).sort().forEach(t => {
    const e = document.createElement('span');
    e.className = 'tag' + (currentTag === t ? ' active' : '');
    e.textContent = `${t}(${map[t]})`;
    e.onclick = () => { currentTag = t; renderAll(); };
    cloud.appendChild(e);
  });
}

function renderMemo() {
  const list = loadData().filter(x => x.type === 'memo');
  const el = document.getElementById('memoList');
  el.innerHTML = '';
  let f = list;
  if (currentTag) f = f.filter(i => i.tags?.includes(currentTag));
  if (f.length === 0) { el.innerHTML = '<div class="empty">æš‚æ— ç¬”è®°</div>'; return; }
  f.forEach(item => {
    const d = document.createElement('div');
    d.className = 'memo-item';
    const time = item.updatedAt !== item.createdAt ? `${item.createdAt}ï¼ˆæ›´æ–°${item.updatedAt}ï¼‰` : item.createdAt;
    d.innerHTML = `
      <div class="memo-time">${time}</div>
      <div class="memo-content">${formatContent(item.content)}</div>
      <div class="memo-actions">
        <span onclick="editMemo(${item.id})">ç¼–è¾‘</span>
        <span onclick="quoteMemo(${item.id})">å¼•ç”¨</span>
        <span class="del" onclick="deleteMemo(${item.id})">åˆ é™¤</span>
      </div>
    `;
    el.appendChild(d);
  });
}

function renderTodo() {
  const list = loadData().filter(x => x.type === 'todo');
  const el = document.getElementById('todoList');
  el.innerHTML = '';
  if (list.length === 0) { el.innerHTML = '<div class="empty">æš‚æ— å¾…åŠ</div>'; return; }
  list.forEach(t => {
    const d = document.createElement('div');
    d.className = 'todo-item' + (t.done ? ' done' : '');
    let recordsHtml = '';
    if (t.records && t.records.length > 0) {
      t.records.forEach(r => {
        recordsHtml += `
          <div class="handle-record">
            <span class="handle-time">${r.time}</span>
            ${r.content}
          </div>
        `;
      });
    }
    d.innerHTML = `
      <div class="todo-hd">
        <input type="checkbox" class="todo-checkbox" ${t.done ? 'checked' : ''} onchange="toggleTodo(${t.id})">
        <div class="todo-tag">${t.done ? 'å·²å®Œæˆ' : 'å¾…å¤„ç†'}</div>
      </div>
      <div class="todo-title">${t.title}</div>
      ${recordsHtml}
      <div class="todo-actions">
        <span onclick="openHandleTodo(${t.id})">å¤„ç†</span>
        <span class="del" onclick="deleteTodo(${t.id})">åˆ é™¤</span>
      </div>
    `;
    el.appendChild(d);
  });
}

function renderAll() {
  renderTags();
  renderMemo();
  renderTodo();
}

// å¯¼å‡ºå¯¼å…¥
function exportData() {
  const d = localStorage.getItem(STORAGE_KEY) || '[]';
  const blob = new Blob([d], { type: 'application/json' });
  const u = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = u;
  a.download = `LocalMemo_${new Date().toLocaleDateString().replace(/\//g, '-')}.json`;
  a.click();
  URL.revokeObjectURL(u);
}
function importData() {
  const i = document.createElement('input');
  i.type = 'file'; i.accept = '.json';
  i.onchange = e => {
    const f = e.target.files[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = ev => {
      try {
        const d = JSON.parse(ev.target.result);
        if (Array.isArray(d)) { saveData(d); renderAll(); alert('å¯¼å…¥æˆåŠŸ'); autoSyncToCloud(); }
      } catch(e) { alert('æ ¼å¼é”™è¯¯'); }
    };
    r.readAsText(f);
  };
  i.click();
}

// åŒæ­¥
function loadSyncConfig() {
  const r = localStorage.getItem(SYNC_CONFIG_KEY);
  if (r) { try { syncConfig = JSON.parse(r); upStatus('å·²åŒæ­¥', 'success'); return true; } catch(e) {} }
  syncConfig = { token: '', gistId: '' }; upStatus('æœªåŒæ­¥', '');
  return false;
}
function upStatus(t, c) {
  const e = document.getElementById('syncStatus');
  e.textContent = t;
  e.className = 'sync-status ' + c;
}
async function syncFromCloud() {
  if (!loadSyncConfig() || syncLock) return;
  syncLock = true; upStatus('æ‹‰å–ä¸­â€¦', 'success');
  try {
    const res = await fetch(`https://api.github.com/gists/${syncConfig.gistId}`, {
      headers: { Authorization: `token ${syncConfig.token}`, 'User-Agent': 'LocalMemo' }
    });
    if (!res.ok) throw new Error(res.status);
    const g = await res.json();
    const file = g.files[Object.keys(g.files)[0]];
    const data = JSON.parse(file.content).data || [];
    saveData(data);
    localStorage.setItem(LAST_SYNC_TIME_KEY, new Date().toISOString());
    upStatus(`å·²åŒæ­¥`, 'success');
    renderAll();
  } catch (e) { upStatus('åŒæ­¥å¤±è´¥', 'error'); }
  syncLock = false;
}
async function autoSyncToCloud() {
  if (!loadSyncConfig()) return;
  syncLock = true; upStatus('åŒæ­¥ä¸­â€¦', 'success');
  try {
    const g = await fetch(`https://api.github.com/gists/${syncConfig.gistId}`);
    const data = await g.json();
    const fn = Object.keys(data.files)[0];
    await fetch(`https://api.github.com/gists/${syncConfig.gistId}`, {
      method: 'PATCH',
      headers: { Authorization: `token ${syncConfig.token}` },
      body: JSON.stringify({ files: { [fn]: { content: JSON.stringify({ data: loadData() }, null, 2) } } })
    });
    upStatus('å·²åŒæ­¥', 'success');
  } catch (e) { upStatus('åŒæ­¥å¤±è´¥', 'error'); }
  syncLock = false;
}

// ç»‘å®š
document.getElementById('submit').onclick = submitMemo;
document.getElementById('cancelEdit').onclick = cancelEdit;
document.getElementById('export').onclick = exportData;
document.getElementById('import').onclick = importData;
document.getElementById('addTodo').onclick = addTodo;

document.getElementById('closeHandleModal').onclick = closeHandleTodo;
document.getElementById('cancelHandle').onclick = closeHandleTodo;
document.getElementById('saveHandle').onclick = saveHandleTodo;

document.getElementById('syncBtn').onclick = () => {
  loadSyncConfig();
  document.getElementById('githubToken').value = syncConfig.token;
  document.getElementById('gistId').value = syncConfig.gistId;
  document.getElementById('syncModal').classList.add('show');
};
document.getElementById('modalClose').onclick = () => {
  document.getElementById('syncModal').classList.remove('show');
};
document.getElementById('saveSyncConfig').onclick = () => {
  const tk = document.getElementById('githubToken').value.trim();
  const gi = document.getElementById('gistId').value.trim();
  if (!tk || !gi) { alert('å¡«å†™å®Œæ•´'); return; }
  syncConfig = { token: tk, gistId: gi };
  localStorage.setItem(SYNC_CONFIG_KEY, JSON.stringify(syncConfig));
  document.getElementById('syncModal').classList.remove('show');
  syncFromCloud();
};
document.getElementById('clearSyncConfig').onclick = () => {
  if (!confirm('æ¸…ç©ºï¼Ÿ')) return;
  localStorage.removeItem(SYNC_CONFIG_KEY);
  localStorage.removeItem(LAST_SYNC_TIME_KEY);
  document.getElementById('syncModal').classList.remove('show');
  loadSyncConfig();
};

// å›è½¦
document.getElementById('content').addEventListener('keydown', e => {
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); submitMemo(); }
});
document.getElementById('todoTitle').addEventListener('keydown', e => {
  if (e.key === 'Enter') { e.preventDefault(); addTodo(); }
});

// å¯åŠ¨
window.onload = () => {
  renderAll();
  if (loadSyncConfig()) syncFromCloud();
};
</script>
</body>
</html>
